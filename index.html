<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title>WebGL Webcam</title>
    <style>
      body {
        margin: 0;
        background-color: #000000;
        overflow: hidden;
      }
    </style>
  </head>
  <body>
    <script src="http://sole.github.com/cdn/Three-r50.js"></script>
    
    <script id="vs" type="x-shader/x-vertex">

      uniform sampler2D map;

      varying vec2 vUv;

      void main() {
        vUv = uv;
        vec4 color = texture2D( map, vUv );
        vec4 pos = vec4( position.xy, 0.0, 1.0 );
        gl_Position = projectionMatrix * modelViewMatrix * pos;
      }
    </script>

    <script id="fs-filter" type="x-shader/x-fragment">
      uniform sampler2D map;
      varying vec2 vUv;

      void main() {
        vec3 rgb = texture2D(map, vUv).rgb;
        float r, g, b;
        r = rgb.r;
        g = rgb.g;
        b = rgb.b;
        if(rgb.r < 0.6){
          r = 0.0;
        }
        if(rgb.g < 0.6){
          g = 0.0;
        }
        if(rgb.b < 0.6){
          b = 0.0;
        }


        gl_FragColor = vec4(r, g, b, 1.0);
      }
    </script>

    <script id="fs" type="x-shader/x-fragment">
      uniform sampler2D map;
      varying vec2 vUv;

      void main() {
        vec3 rgb = texture2D(map, vUv).rgb;
        gl_FragColor = vec4(rgb, 1.0);
      }
    </script>
    
    <script>
      
      // webcam
      
      window.URL = window.URL || window.webkitURL || window.mozURL || window.msURL;
      navigator.getUserMedia = navigator.getUserMedia || navigator.webkitGetUserMedia || navigator.mozGetUserMedia || navigator.msGetUserMedia;
      
      var video = document.createElement( 'video' );
      video.autoplay = true;
      
      video.addEventListener( 'loadedmetadata', function ( event ) {
        video.style.width = video.videoWidth + 'px';
        video.style.height = video.videoHeight + 'px';
        init();
      } );

      navigator.getUserMedia( { video: true }, function ( stream ) {
        video.src = window.URL.createObjectURL( stream );
      }, function ( error ) {
        console.log( error );
      } );
      
      // 3d
      
      var camera, scene1, scene2, renderer;
      var filter = 0;

      var currentlyPressedKeys = {};

      function handleKeyDown(event) {
        currentlyPressedKeys[event.keyCode] = true;
      }

      function handleKeyUp(event) {
        currentlyPressedKeys[event.keyCode] = false;
      }

      function handleKeys() {
        if (currentlyPressedKeys[38]) {
          // Up Arrow key
          filter = 1-filter;
        }
      }
      
      var init = function () {
        camera = new THREE.PerspectiveCamera( 50, window.innerWidth / window.innerHeight, 1, 1000 );
        camera.position.z = 500;
        
        scene1 = new THREE.Scene();
        scene2 = new THREE.Scene();
        
        texture = new THREE.Texture( video );
        texture.minFilter = THREE.NearestFilter;
        texture.magFilter = THREE.NearestFilter;
        texture.format = THREE.RGBFormat;
        texture.generateMipmaps = false;
        texture.needsUpdate = true;
        
        document.onkeydown = handleKeyDown;
        document.onkeyup = handleKeyUp;
        var geometry = new THREE.PlaneGeometry( video.videoWidth, video.videoHeight );
        
        var material1 = new THREE.ShaderMaterial( {
          uniforms: {
            "map": { type: "t", value: 0, texture: texture }
          },
          vertexShader: document.getElementById( 'vs' ).textContent,
          fragmentShader: document.getElementById( 'fs-filter' ).textContent
        } );
        
        var material2 = new THREE.ShaderMaterial( {
          uniforms: {
            "map": { type: "t", value: 0, texture: texture }
          },
          vertexShader: document.getElementById( 'vs' ).textContent,
          fragmentShader: document.getElementById( 'fs' ).textContent
        } );
        
        var mesh1 = new THREE.Mesh( geometry, material1 );
        var mesh2 = new THREE.Mesh( geometry, material2 );
        scene1.add( mesh1 );
        scene2.add( mesh2 );
        
        renderer = new THREE.WebGLRenderer();
        renderer.setSize( window.innerWidth, window.innerHeight );
        document.body.appendChild( renderer.domElement );
        renderer.domElement.style.width = window.innerWidth + 'px';
        renderer.domElement.style.height = window.innerHeight + 'px';

        
        animate();
      };
      
      var animate = function () {
        requestAnimationFrame( animate );
        handleKeys();
        if ( video.readyState === video.HAVE_ENOUGH_DATA ) {
          texture.needsUpdate = true;
        }
        if(filter == 1){
          renderer.render( scene1, camera );
        }else {
          renderer.render( scene2, camera );
        }
      };
    </script>
  </body>
</html>